# CI Workflow
# Runs on every push and PR to validate code quality
#
# Branching strategy:
#   feature/*, fix/*, chore/*, docs/* → PR → dev (default, WIP baseline)
#                                              → PR → main (protected, stable)

name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Code Quality Checks (runs on all PRs and pushes)
  # ==========================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
      fail-fast: false # Continue testing other versions if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # ==========================================================================
  # Security Audit (detailed, runs on PRs to main only)
  # ==========================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.base_ref == 'main' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Full security audit
        run: npm audit --audit-level=moderate

  # ==========================================================================
  # Integration Test (optional, requires secrets)
  # ==========================================================================
  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: validate
    # Only run on dev branch pushes, and only if secrets are configured
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/dev' &&
      vars.ENABLE_INTEGRATION_TESTS == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Operaton connection
        run: npm run check
        env:
          OPERATON_BASE_URL: ${{ secrets.OPERATON_BASE_URL }}
          OPERATON_REST_URL: ${{ secrets.OPERATON_REST_URL }}
          OPERATON_USERNAME: ${{ secrets.OPERATON_USERNAME }}
          OPERATON_PASSWORD: ${{ secrets.OPERATON_PASSWORD }}

  # ==========================================================================
  # PR Labels (auto-label based on branch name)
  # ==========================================================================
  label-pr:
    name: Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Add labels based on branch
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const labels = [];
            
            if (branch.startsWith('feature/') || branch.startsWith('feat/')) {
              labels.push('enhancement');
            } else if (branch.startsWith('fix/') || branch.startsWith('bug/')) {
              labels.push('bug');
            } else if (branch.startsWith('docs/')) {
              labels.push('documentation');
            } else if (branch.startsWith('chore/')) {
              labels.push('chore');
            } else if (branch.startsWith('refactor/')) {
              labels.push('refactor');
            }
            
            // Add target branch label
            if (context.payload.pull_request.base.ref === 'main') {
              labels.push('release');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

  # ==========================================================================
  # Status Check (summary job for branch protection)
  # ==========================================================================
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [validate]
    if: always()

    steps:
      - name: Check validation results
        run: |
          if [[ "${{ needs.validate.result }}" == "failure" ]]; then
            echo "❌ Validation failed"
            exit 1
          fi
          echo "✅ All checks passed"
